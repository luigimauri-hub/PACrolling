<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Macchina del Tempo - MSCI World Simulator</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.98);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        h1 {
            color: #2c3e50;
            margin: 0 0 5px 0;
            text-align: center;
            font-size: 2.8em;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        .time-machine-subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 1.2em;
            font-style: italic;
            border-bottom: 1px dashed #3498db;
            padding-bottom: 10px;
        }
        
        /* Guida per il cliente - Stili */
        .guide-container {
            margin-bottom: 25px;
            border: 2px solid #3498db;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .guide-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            font-size: 1.1em;
        }
        .guide-header:hover {
            background: linear-gradient(135deg, #1e2b37, #2980b9);
        }
        .guide-header span:first-child {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .guide-content {
            background: #f8f9fa;
            padding: 20px;
            display: none;
            max-height: 600px;
            overflow-y: auto;
        }
        .guide-content.show {
            display: block;
        }
        .guide-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .guide-section h3 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 1.3em;
            border-left: 5px solid #3498db;
            padding-left: 15px;
        }
        .step-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .step-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #3498db;
        }
        .step-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 8px;
        }
        .scenario-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 8px;
        }
        .scenario-optimist { background: #fff5e6; color: #e67e22; border: 1px solid #f39c12; }
        .scenario-realist { background: #e8f5e9; color: #27ae60; border: 1px solid #2ecc71; }
        .scenario-prudent { background: #e3f2fd; color: #1976d2; border: 1px solid #3498db; }
        .question-list {
            list-style: none;
            padding: 0;
        }
        .question-list li {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #f39c12;
        }
        .tip-box {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            background: #f0f5fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #bdd3e8;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-weight: 700;
            color: #2c3e50;
            font-size: 0.95em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .control-group input, .control-group select {
            padding: 12px 14px;
            border: 2px solid #bdc3c7;
            border-radius: 10px;
            font-size: 1em;
            background: white;
            transition: all 0.2s;
            width: 100%;
        }
        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        .control-group input[type="range"] {
            padding: 0;
            height: 8px;
        }
        .amount-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .amount-input span {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.2em;
        }
        .amount-input input {
            flex: 1;
        }
        .strategy-section {
            grid-column: span 3;
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 5px;
            border: 2px solid #3498db;
            box-shadow: 0 4px 10px rgba(52,152,219,0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        .strategy-section.selected {
            border-color: #e67e22;
            box-shadow: 0 4px 15px rgba(230,126,34,0.3);
        }
        .strategy-title {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .strategy-title span {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 30px;
            font-size: 0.8em;
        }
        .pac-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .pic-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #bdc3c7;
        }
        .allocation-group {
            grid-column: span 3;
            background: #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-top: 10px;
            border: 1px solid #bdc3c7;
        }
        .allocation-sliders {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 15px;
        }
        .slider-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .slider-item label {
            font-weight: 600;
            color: #2c3e50;
        }
        .slider-value {
            font-weight: bold;
            color: #3498db;
            font-size: 1.2em;
            background: white;
            padding: 5px 15px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid #bdc3c7;
        }
        .slider-item input[type="range"] {
            width: 100%;
            height: 8px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #2c3e50 0%, #1e2b37 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border: 1px solid #4a5a6a;
        }
        .stat-card.highlight {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        .stat-card.volatility {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
        }
        .stat-value {
            font-size: 1.6em;
            font-weight: bold;
            margin: 5px 0;
        }
        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e1e8ed;
            height: 500px;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 0 10px;
        }
        .table-header select {
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.95em;
            background: white;
            min-width: 200px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            font-weight: 600;
            z-index: 10;
        }
        td {
            padding: 10px;
            border-bottom: 1px solid #e1e8ed;
        }
        tr:hover {
            background: #f5f5f5;
        }
        .positive {
            color: #27ae60;
            font-weight: 600;
        }
        .negative {
            color: #e74c3c;
            font-weight: 600;
        }
        .view-trip-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }
        .view-trip-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }
        .tab-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 12px 25px;
            background: white;
            border: none;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 700;
            color: #2c3e50;
            font-size: 1em;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #bdc3c7;
        }
        .tab-button.active {
            background: #2c3e50;
            color: white;
            transform: scale(1.02);
            border-color: #1e2b37;
        }
        .tab-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tab-content.active {
            display: block;
            opacity: 1;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 15px;
        }
        .comparison-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid #e1e8ed;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .comparison-card h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.2em;
        }
        .comparison-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
            color: #3498db;
        }
        .legend-box {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 4px;
            vertical-align: middle;
        }
        .chart-legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
            border: 1px solid #e1e8ed;
        }
        .time-machine-button {
            grid-column: span 3;
            display: flex;
            justify-content: center;
            margin: 20px 0 10px 0;
        }
        .start-button {
            background: linear-gradient(135deg, #e67e22, #d35400);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.6em;
            font-weight: 700;
            border-radius: 60px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(230,126,34,0.3);
            border: 2px solid #f39c12;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .start-button:hover {
            background: linear-gradient(135deg, #d35400, #e67e22);
            transform: scale(1.05);
            box-shadow: 0 15px 30px rgba(230,126,34,0.4);
        }
        .start-button:active {
            transform: scale(0.95);
        }
        .footer {
            margin-top: 30px;
            padding: 20px;
            background: #f0f5fa;
            border-radius: 12px;
            font-size: 0.85em;
            color: #5d6d7e;
            border-top: 3px solid #2c3e50;
        }
        .footer p {
            margin: 5px 0;
        }
        .footer strong {
            color: #2c3e50;
        }
        .credit {
            text-align: right;
            font-size: 1.1em;
            margin-top: 10px;
            color: #2c3e50;
            font-weight: 700;
            border-top: 1px solid #bdc3c7;
            padding-top: 15px;
        }
        .info-badge {
            background: #2c3e50;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
        }
        .total-versamenti {
            font-size: 0.85em;
            color: #2c3e50;
            margin-top: 5px;
            font-weight: 600;
        }
        .holding-period {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid #3498db;
        }
        .holding-slider {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .strategy-label {
            font-size: 1.1em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .strategy-label span {
            background: #3498db;
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            overflow: auto;
        }
        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 25px;
            border-radius: 20px;
            width: 95%;
            max-width: 1200px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }
        .close-modal {
            font-size: 2em;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.2s;
        }
        .close-modal:hover {
            color: #e74c3c;
        }
        .trip-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #bdc3c7;
        }
        .detail-label {
            font-weight: 600;
            color: #2c3e50;
        }
        .detail-value {
            font-weight: 700;
            color: #3498db;
        }
        .modal-legend {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 50px;
            flex-wrap: wrap;
        }
        .modal-chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .modal-chart-container {
            background: white;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e1e8ed;
            height: 350px;
            position: relative;
        }
        .modal-chart-title {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .modal-chart-subtitle {
            text-align: center;
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .alignment-note {
            background: #e8f4fd;
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 10px;
            font-size: 0.85em;
            text-align: center;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° LA MACCHINA DEL TEMPO ‚ö°</h1>
        <div class="time-machine-subtitle">Historical Market Risk Simulator - MSCI World</div>
        
        <!-- GUIDA INTERATTIVA PER IL CLIENTE -->
        <div class="guide-container">
            <div class="guide-header" id="guideToggle">
                <span>
                    <span style="font-size: 1.5em;">üìò</span>
                    GUIDA: Come utilizzare il simulatore
                </span>
                <span id="toggleIcon" style="font-size: 1.3em;">‚ñº</span>
            </div>
            
            <div class="guide-content" id="guideContent">
                <div class="guide-section">
                    <h3>üìä Finalit√† dello strumento</h3>
                    <p>Il presente simulatore consente di analizzare l'andamento storico dell'indice MSCI World dal 1979 ad oggi, offrendo una prospettiva concreta su come si sarebbero comportati diversi tipi di investimento in differenti condizioni di mercato. L'analisi si basa esclusivamente su <strong>dati storici reali</strong>, senza alcuna proiezione o promessa di rendimenti futuri.</p>
                    <p>Attraverso un utilizzo consapevole di questo strumento, √® possibile ottenere elementi di valutazione utili per orientare le seguenti decisioni di investimento:</p>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px;">
                        <div style="background: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; flex: 1; min-width: 200px;">
                            <div style="font-weight: 700; color: #2c3e50; margin-bottom: 8px;">1. Propensione al rischio</div>
                            <div style="font-size: 0.95em; color: #5d6d7e;">Quale livello di volatilit√† e perdita potenziale √® tollerabile in base ai propri obiettivi?</div>
                        </div>
                        <div style="background: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; flex: 1; min-width: 200px;">
                            <div style="font-weight: 700; color: #2c3e50; margin-bottom: 8px;">2. Orizzonte temporale</div>
                            <div style="font-size: 0.95em; color: #5d6d7e;">Qual √® il periodo minimo di investimento necessario per aumentare la probabilit√† di risultati positivi?</div>
                        </div>
                        <div style="background: #f8f9fa; border-left: 4px solid #3498db; padding: 15px; flex: 1; min-width: 200px;">
                            <div style="font-weight: 700; color: #2c3e50; margin-bottom: 8px;">3. Strategia di ingresso</div>
                            <div style="font-size: 0.95em; color: #5d6d7e;">Quale modalit√† (PIC o PAC) risulta pi√π appropriata in funzione delle proprie disponibilit√† e obiettivi?</div>
                        </div>
                    </div>
                </div>
                
                <div class="guide-section">
                    <h3>üéÆ 3 scenari da provare subito</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                        <div style="border-radius: 10px; overflow: hidden;">
                            <div style="background: #f39c12; color: white; padding: 10px; text-align: center; font-weight: 600;">üòé L'OTTIMISTA</div>
                            <div style="background: #fff5e6; padding: 15px;">
                                <div><span class="scenario-badge scenario-optimist">100% Azioni</span> <span class="scenario-badge scenario-optimist">10 anni</span></div>
                                <div style="margin-top: 10px; font-size: 0.9em;">Guarda i TOP 10: cosa succede nei periodi migliori (anni '90, dopo il 2009).</div>
                            </div>
                        </div>
                        <div style="border-radius: 10px; overflow: hidden;">
                            <div style="background: #27ae60; color: white; padding: 10px; text-align: center; font-weight: 600;">üßê IL REALISTA</div>
                            <div style="background: #e8f5e9; padding: 15px;">
                                <div><span class="scenario-badge scenario-realist">PAC 500‚Ç¨</span> <span class="scenario-badge scenario-realist">15 anni</span></div>
                                <div style="margin-top: 10px; font-size: 0.9em;">Quanti periodi sono positivi? Quanti negativi? Guarda la % di periodi positivi in alto.</div>
                            </div>
                        </div>
                        <div style="border-radius: 10px; overflow: hidden;">
                            <div style="background: #3498db; color: white; padding: 10px; text-align: center; font-weight: 600;">üõ°Ô∏è IL PRUDENTE</div>
                            <div style="background: #e3f2fd; padding: 15px;">
                                <div><span class="scenario-badge scenario-prudent">70% Azioni</span> <span class="scenario-badge scenario-prudent">30% Garantito</span></div>
                                <div style="margin-top: 10px; font-size: 0.9em;">Nel grafico appare la linea verde: cresce sempre, anche quando il mercato crolla.</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tip-box">
                    <strong>üí° Consiglio:</strong> Prova a trovare il tuo "punto di equilibrio". Inizia con 100% azioni e guarda il peggior scenario. Poi aumenta gradualmente la parte garantita finch√© il peggior risultato storico non diventa accettabile per te. Quel mix definisce il tuo profilo di rischio.
                </div>
                
                <div class="warning-box" style="margin-top: 15px;">
                    <strong>‚ö†Ô∏è Limiti dello strumento:</strong>
                    <ul style="margin: 10px 0 0 0; padding-left: 20px;">
                        <li>Non prevede il futuro (i mercati possono fare meglio o peggio del passato)</li>
                        <li>Non considera la fiscalit√† (26% sulle plusvalenze nella realt√†)</li>
                        <li>Non considera l'inflazione</li>
                        <li>Non considera commissioni e costi dei prodotti finanziari</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="controls-grid">
            <!-- STRATEGIA PAC (MENSILE) - Prima opzione -->
            <div class="strategy-section" id="pacSection">
                <div class="strategy-title">
                    üìà STRATEGIA PAC - ACCUMULO MENSILE 
                    <span>PRIMA OPZIONE</span>
                </div>
                <div class="pac-options">
                    <div class="control-group">
                        <label>üí∞ Importo PAC (mensile)</label>
                        <div class="amount-input">
                            <span>‚Ç¨</span>
                            <input type="number" id="pacAmount" min="50" max="50000" value="500" step="50">
                        </div>
                        <div class="total-versamenti" id="totalPacDisplay">Totale versato: ‚Ç¨0</div>
                    </div>
                    
                    <div class="control-group">
                        <label>‚è±Ô∏è Durata Accumulo PAC</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="range" id="duration" min="1" max="20" value="5" step="0.5" style="flex: 1;">
                            <span class="info-badge" id="durationValue">5 anni</span>
                        </div>
                    </div>
                </div>
                
                <!-- Periodo di detenzione aggiuntivo (solo per PAC) -->
                <div class="holding-period">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: 600; color: #2c3e50; font-size: 1em;">‚è≥ Periodo di Detenzione Aggiuntivo (dopo l'accumulo PAC)</span>
                        <span class="info-badge">Opzionale</span>
                    </div>
                    <div class="holding-slider">
                        <div style="display: flex; justify-content: space-between;">
                            <label>Anni di detenzione senza versamenti:</label>
                            <span class="slider-value" id="holdingValue">0 anni</span>
                        </div>
                        <input type="range" id="holdingPeriod" min="0" max="10" value="0" step="0.5">
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #2c3e50; background: white; padding: 8px; border-radius: 20px;">
                        Periodo totale: <span id="totalPeriod">5</span> anni (accumulo + detenzione)
                    </div>
                </div>
            </div>
            
            <!-- STRATEGIA PIC (UNICO) - Seconda opzione -->
            <div class="strategy-section" id="picSection">
                <div class="strategy-title">
                    üí∞ STRATEGIA PIC - INVESTIMENTO UNICO 
                    <span>SECONDA OPZIONE</span>
                </div>
                <div class="pic-options">
                    <div class="control-group">
                        <label>üí∞ Importo PIC (versamento unico)</label>
                        <div class="amount-input">
                            <span>‚Ç¨</span>
                            <input type="number" id="lumpAmount" min="1000" max="1000000" value="30000" step="1000">
                        </div>
                    </div>
                    
                    <div class="control-group" style="margin-top: 10px;">
                        <label>‚è±Ô∏è Nota per PIC</label>
                        <div style="background: #e8f4fd; padding: 10px; border-radius: 8px; font-size: 0.9em;">
                            Per il PIC, la durata e l'eventuale detenzione si riferiscono allo stesso periodo impostato per il PAC.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Allocazione personalizzata - Comune a entrambe le strategie -->
            <div class="allocation-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <span style="font-weight: 700; color: #2c3e50; font-size: 1.2em;">üìä ALLOCAZIONE PORTAFOGLIO</span>
                    <span class="info-badge">Garantito 2% composto</span>
                </div>
                <div class="allocation-sliders">
                    <div class="slider-item">
                        <div style="display: flex; justify-content: space-between;">
                            <label>üõ°Ô∏è % Componente Garantita (2%)</label>
                            <span class="slider-value" id="guaranteedPctValue">0%</span>
                        </div>
                        <input type="range" id="guaranteedPct" min="0" max="100" value="0" step="5">
                    </div>
                    <div class="slider-item">
                        <div style="display: flex; justify-content: space-between;">
                            <label>üìà % MSCI World - Azionario globale</label>
                            <span class="slider-value" id="msciPctValue">100%</span>
                        </div>
                        <input type="range" id="msciPct" min="0" max="100" value="100" step="5">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px; font-size: 1.1em; color: #2c3e50; font-weight: 700; background: white; padding: 12px; border-radius: 40px; border: 2px solid #3498db;" id="allocationDescription">
                    100% MSCI World | 0% Garantito
                </div>
            </div>
            
            <!-- Pulsante Avvia Macchina del Tempo -->
            <div class="time-machine-button">
                <button class="start-button" id="startSimulation">
                    <span>‚ö°</span> AVVIA LA MACCHINA DEL TEMPO <span>‚ö°</span>
                </button>
            </div>
        </div>

        <div class="stats-grid" id="stats">
            <!-- Verr√† popolato via JavaScript -->
        </div>

        <div class="tab-buttons">
            <button class="tab-button active" data-tab="grafico">üìà GRAFICO VIAGGIO NEL TEMPO</button>
            <button class="tab-button" data-tab="simulazioni">üìã TABELLE STORICHE</button>
            <button class="tab-button" data-tab="confronto">üîÑ CONFRONTO STRATEGIE</button>
        </div>

        <div id="graficoTab" class="tab-content active">
            <div class="chart-container">
                <canvas id="bundleChart"></canvas>
                <div class="chart-legend">
                    <div>
                        <span class="legend-box" style="background: rgba(52, 152, 219, 0.5);"></span>
                        <span>Viaggi nel tempo (<span id="simCount">0</span> percorsi)</span>
                    </div>
                    <div>
                        <span class="legend-box" style="background: #e74c3c; border: 2px solid #c0392b;"></span>
                        <span>Capitale Versato</span>
                    </div>
                    <div>
                        <span class="legend-box" style="background: #f39c12;"></span>
                        <span>Media percorsi</span>
                    </div>
                    <div>
                        <span class="legend-box" style="background: #27ae60;"></span>
                        <span>Garantito 2% (riferimento)</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="simulazioniTab" class="tab-content">
            <div class="table-container">
                <div class="table-header">
                    <span style="font-weight: 600; color: #2c3e50;">üìã Elenco viaggi storici</span>
                    <select id="displayType">
                        <option value="all">Tutti i periodi</option>
                        <option value="best">Top 10 migliori</option>
                        <option value="worst">Top 10 peggiori</option>
                    </select>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Periodo Accumulo</th>
                            <th>Periodo Detenzione</th>
                            <th>Investito</th>
                            <th>Valore Finale</th>
                            <th>Plusvalenza</th>
                            <th>Rend.% Periodo</th>
                            <th>Rend.% Annuo</th>
                            <th>Volatilit√†</th>
                            <th>Dettaglio</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="confrontoTab" class="tab-content">
            <div class="comparison-grid">
                <div class="comparison-card">
                    <h3>üí∞ PIC</h3>
                    <div class="comparison-value" id="lumpAvg">0%</div>
                    <div>Rendimento Medio Annuo</div>
                    <div style="margin-top: 15px; color: #27ae60;" id="lumpBest">üìà Migliore: 0%</div>
                    <div style="color: #e74c3c;" id="lumpWorst">üìâ Peggiore: 0%</div>
                </div>
                <div class="comparison-card">
                    <h3>üìà PAC</h3>
                    <div class="comparison-value" id="pacAvg">0%</div>
                    <div>Rendimento Medio Annuo</div>
                    <div style="margin-top: 15px; color: #27ae60;" id="pacBest">üìà Migliore: 0%</div>
                    <div style="color: #e74c3c;" id="pacWorst">üìâ Peggiore: 0%</div>
                </div>
                <div class="comparison-card">
                    <h3>‚è≥ PAC + Detenzione</h3>
                    <div class="comparison-value" id="detAvg">0%</div>
                    <div>Rendimento Medio Annuo</div>
                    <div style="margin-top: 15px; color: #27ae60;" id="detBest">üìà Migliore: 0%</div>
                    <div style="color: #e74c3c;" id="detWorst">üìâ Peggiore: 0%</div>
                </div>
            </div>
        </div>
        
        <!-- Modal per il dettaglio del viaggio -->
        <div id="tripModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìä Dettaglio Viaggio Storico</h2>
                    <span class="close-modal" id="closeModal">&times;</span>
                </div>
                <div class="alignment-note">
                    ‚ö° I grafici sono allineati temporalmente: stesso periodo, stessa scala temporale
                </div>
                <div class="trip-details" id="tripDetails">
                    <!-- Popolato via JavaScript -->
                </div>
                <div class="modal-legend">
                    <div>
                        <span class="legend-box" style="background: #3498db;"></span>
                        <span>TuO investimento</span>
                    </div>
                    <div>
                        <span class="legend-box" style="background: #e74c3c; border: 2px solid #c0392b;"></span>
                        <span>Capitale Versato</span>
                    </div>
                    <div>
                        <span class="legend-box" style="background: #2c3e50;"></span>
                        <span>MSCI World (scala reale)</span>
                    </div>
                </div>
                <div class="modal-chart-grid">
                    <div>
                        <div class="modal-chart-title">üìà Il tuo investimento nel tempo</div>
                        <div class="modal-chart-subtitle">Confronto tra valore investimento e capitale versato</div>
                        <div class="modal-chart-container">
                            <canvas id="tripInvestmentChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <div class="modal-chart-title">üåç Andamento MSCI World nel periodo</div>
                        <div class="modal-chart-subtitle" id="msciPeriodLabel">Valori reali dell'indice</div>
                        <div class="modal-chart-container">
                            <canvas id="tripMsciChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer con disclaimer -->
        <div class="footer">
            <p><strong>‚ö†Ô∏è DISCLAIMER:</strong> Il presente strumento √® fornito a scopo puramente informativo ed educativo. I dati storici non sono indicativi dei rendimenti futuri. Investire in strumenti finanziari comporta un rischio di perdita del capitale. Le simulazioni non tengono conto di costi di transazione, fiscalit√†, inflazione o altri oneri. Si raccomanda di consultare un consulente finanziario professionista prima di prendere qualsiasi decisione di investimento.</p>
            <p><strong>üìä Fonte dati:</strong> Rendimenti storici MSCI World EUR (1979-2026). I rendimenti sono calcolati al lordo di commissioni e tasse.</p>
            <p><strong>‚ö° Nota:</strong> La linea verde del grafico mostra l'andamento di un investimento interamente garantito al 2% annuo composto, fornito come riferimento indipendentemente dall'allocazione scelta.</p>
            <div class="credit">
                <strong>‚úçÔ∏è Credit: Luigi Mauri</strong> - La Macchina del Tempo
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Toggle per la guida
        document.getElementById('guideToggle').addEventListener('click', function() {
            const content = document.getElementById('guideContent');
            const icon = document.getElementById('toggleIcon');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                icon.innerHTML = '‚ñº';
            } else {
                content.classList.add('show');
                icon.innerHTML = '‚ñ≤';
            }
        });

        // Variabile per tracciare il tipo di investimento selezionato
        let currentInvestmentType = 'pac'; // Default: PAC
        
        // Variabili per i grafici del viaggio singolo
        let tripInvestmentChart = null;
        let tripMsciChart = null;
        let bundleChart = null;

        // Funzione per aggiornare il totale versamenti PAC
        function updateTotalPac() {
            const pacAmount = parseFloat(document.getElementById('pacAmount').value);
            const duration = parseFloat(document.getElementById('duration').value);
            const months = duration * 12;
            const totalPac = pacAmount * months;
            document.getElementById('totalPacDisplay').innerHTML = `üí∞ Totale versato: ‚Ç¨${totalPac.toLocaleString()}`;
        }

        // Aggiorna periodo totale
        function updateTotalPeriod() {
            const duration = parseFloat(document.getElementById('duration').value);
            const holding = parseFloat(document.getElementById('holdingPeriod').value);
            document.getElementById('totalPeriod').innerText = (duration + holding).toFixed(1);
            document.getElementById('holdingValue').innerText = holding + ' anni';
            document.getElementById('durationValue').innerText = duration + ' anni';
        }

        // Dati storici MSCI World (rendimenti mensili 1979-2026)
        const RETURNS = [
            3.99, -1.44, 4.16, 0.97, -0.65, 1.69, -2.86, 4.33, 1.14, -7.04, 2.66, 0.37,
            4.97, 0.97, -6.03, 7.82, 0.38, 3.25, 1.79, 3.97, 2.75, 5.50, 7.83, 0.90,
            -2.62, 7.12, 3.62, 2.70, 4.03, 3.64, 1.30, 0.68, -11.72, 0.00, 6.27, -0.78,
            0.03, -2.93, -0.96, 6.52, -5.86, 1.01, 0.82, 7.90, 1.39, 8.13, 7.05, 0.18,
            1.40, 3.96, 4.03, 8.67, -0.37, 6.29, -0.46, 3.79, 2.08, -2.81, 5.31, 3.84,
            3.08, -4.68, 0.97, 1.39, -4.07, 0.83, 0.11, 11.26, 4.32, 2.90, -2.99, 6.11,
            8.08, 3.92, 3.69, -7.19, 5.86, 0.00, -2.93, -2.65, 2.36, -1.11, 3.53, 2.20,
            -0.63, 4.71, 6.73, 3.28, -2.04, 4.42, -2.16, 5.46, -4.74, -2.82, 5.29, 0.53,
            5.03, 1.46, 6.01, 4.48, -1.08, 1.72, 3.46, 6.74, -4.31, -17.59, -8.34, 1.14,
            3.50, 8.84, 1.61, 0.64, -1.05, 3.55, 6.99, -3.40, 3.46, 4.00, -0.64, 0.99,
            7.70, 0.58, 0.00, 2.85, 1.71, 0.63, 6.42, -0.93, 4.38, -7.00, 2.48, -1.06,
            -7.49, -5.58, -4.42, -2.73, 8.70, -0.07, -2.16, -13.38, -10.43, 6.09, -3.62, 3.26,
            3.88, 7.41, 5.60, 6.12, 3.60, -2.70, 4.82, -2.54, -0.24, 1.46, -7.96, 3.84,
            -1.19, 0.41, -2.20, 0.45, 1.96, -6.15, -4.54, -0.18, 1.34, 1.31, 8.42, 0.71,
            2.26, 4.89, 6.29, 1.05, 2.53, 2.03, 6.36, 5.36, -5.77, 3.94, -3.15, 4.82,
            8.02, -1.70, -6.31, 3.37, -1.92, -1.92, -1.26, 3.11, -3.69, 0.86, -2.94, 3.01,
            -3.54, 0.32, 0.72, 1.48, 2.39, -0.89, 3.76, 0.71, 4.21, -3.13, 3.67, 4.53,
            3.02, 1.17, 1.58, 3.20, 1.28, -0.29, -5.02, 0.21, 4.79, 0.99, 4.23, 0.56,
            3.94, 5.54, -0.86, 3.81, 5.83, 6.15, 7.50, -4.04, 2.65, -7.00, -0.34, 3.93,
            5.13, 6.51, 4.59, 0.28, -2.77, 3.10, 0.06, -13.71, -3.00, 5.00, 9.00, 4.20,
            5.51, 0.56, 6.82, 5.35, -2.37, 5.95, -3.72, 0.95, -1.84, 7.32, 6.42, 8.63,
            -3.28, 1.05, 8.70, 0.69, -4.83, 0.62, 0.46, 7.15, -3.81, 2.38, -8.97, -5.18,
            2.06, -8.02, -2.18, 6.84, 3.31, -3.15, -4.44, -9.00, -8.56, 2.91, 7.61, 1.59,
            -1.06, -1.04, 3.53, -6.45, -3.88, -11.62, -6.64, -0.34, -11.25, 7.33, 4.71, -9.94,
            -6.00, -1.44, -1.36, 6.55, -0.48, 5.23, 3.00, 5.80, -5.66, 6.20, -1.64, 0.91,
            3.62, 1.40, 0.91, 0.22, -1.17, 2.41, -2.33, -0.16, -0.56, -0.19, 0.84, 1.33,
            2.14, 1.44, 0.28, -2.13, 6.94, 2.86, 3.48, -0.11, 3.93, -2.27, 5.56, 1.97,
            1.70, 1.89, 0.27, -0.52, -5.90, 1.19, 0.20, 1.93, 2.72, 3.38, -1.46, 2.27,
            2.87, -2.46, 1.01, 2.21, 3.96, -1.15, -3.66, -0.06, 1.25, 1.16, -6.13, -1.02,
            -8.57, -2.53, -5.00, 7.10, 1.73, -9.47, -1.49, 4.46, -9.23, -9.14, -6.25, -5.62,
            -0.92, -9.02, 2.17, 11.49, 2.69, -0.70, 8.44, 3.15, 1.35, -2.82, 2.54, 6.16,
            -1.11, 4.37, 6.91, 1.25, -2.17, -3.14, 1.83, -1.09, 1.57, 2.16, 4.31, 4.43,
            -0.21, 2.44, -3.59, -0.33, 1.16, -2.04, -0.48, -8.27, -2.23, 6.42, 1.80, 3.64,
            3.13, 2.80, 1.95, -0.07, -2.66, 3.53, 3.81, -0.12, 0.21, -1.16, 1.34, 0.27,
            2.33, 3.38, 4.93, 1.04, 0.55, -3.02, 3.72, -1.83, 2.90, 2.88, 2.00, 0.78,
            -1.74, 2.75, 0.33, 0.57, 3.79, 1.41, 0.46, 3.68, 1.96, 1.12, 2.34, 1.16,
            5.45, 6.47, 2.84, -1.82, 2.59, -4.24, 3.86, -8.68, -3.59, 9.74, 3.62, -4.54,
            -6.27, -0.45, 2.12, 1.42, 2.81, -0.66, 4.12, -0.09, 0.27, -0.01, 4.40, 3.31,
            0.38, 4.31, 0.18, -0.74, -0.53, -1.30, -0.36, -0.69, 2.41, 3.36, 0.35, 0.14,
            1.36, -2.24, -3.03, 3.18, 3.89, 0.30, 2.44, 1.98, 1.21, -5.23, 0.77, -8.34,
            7.42, 3.66, 2.95, 3.70, -5.20, 4.45, 2.56, -1.02, 3.51, 0.11, 4.40, 0.69,
            1.03, -7.83, -13.06, 11.74, 2.38, 2.08, -0.96, 5.86, -1.54, -2.98, 10.13, 1.77,
            0.11, 2.69, 6.82, 1.56, 0.45, 4.20, 1.73, 2.98, -2.04, 5.06, 0.24, 4.61,
            -3.85, -2.90, 3.65, -3.43, -1.54, -5.80, 9.94, -2.28, -6.95, 5.38, 2.19, -6.85,
            5.43, -0.44, 0.66, 0.77, 1.76, 4.26, 1.89, -1.00, -1.84, -3.13, 6.25, 3.78,
            3.19, 4.35, 3.36, -2.88, 3.18, 3.43, 0.61, 0.25, 0.84, 0.84, 7.75, -0.95,
            3.49, -0.89, -8.02, -4.06, 6.24, 0.92, 3.71, 0.74, 2.48, 3.65, 0.18, -0.77,
            0.79
        ];

        // DATI REALI DELL'INDICE MSCI WORLD (valori assoluti dal file chart.csv)
        const MSCI_INDEX = [
            10000, 10398.930905250509, 10248.849017195265, 10675.226277917642, 10778.50358279821, 10708.880944697637, 10889.84575852203, 10578.590506604152, 11036.524853554603, 11162.378098026924, 10376.16510293369, 10651.72398360166, 10690.898083358963,
            11222.644152383618, 11331.976524858843, 10648.959921826556, 11481.555130843206, 11524.620863031954, 11899.479614256963, 12112.443054965368, 12593.610215946585, 12940.50819136116, 13651.988424485868, 14720.80969969001, 14852.777656733124,
            14463.167712691038, 15492.392711318944, 16052.980807362164, 16486.545396880545, 17151.11818447906, 17776.102685456586, 18007.194521247326, 18130.394515906635, 16005.212422046532, 16005.92215478959, 17009.80602398687, 16876.439053870592,
            16881.135392354838, 16385.868405302343, 16227.944726131596, 17285.722889362583, 16273.17833573479, 16438.284350643284, 16573.143717930932, 17882.283764432374, 18131.556845189443, 19604.697884395795, 20986.4713664931, 21023.74673104958,
            21318.754321023876, 22163.51841819067, 23056.57870135659, 25056.054263461087, 24962.871570881693, 26533.105652752358, 26410.84284460705, 27411.097731117166, 27981.25780028119, 27194.328512790005, 28639.75622804067, 29738.385513379875,
            30654.85931613871, 29221.455242028762, 29503.60589201104, 29913.11483894515, 28694.774730638917, 28934.331593727657, 28967.16865512922, 32229.765663017726, 33621.36624044726, 34594.62624265953, 33559.79206469479, 35609.46600893423,
            38486.3587230083, 39993.182541852475, 41469.22422550362, 38489.090820548394, 40743.73145553946, 40742.04246084016, 39548.87472097862, 38498.9529361696, 39409.12599100308, 38972.698766852656, 40349.80151346892, 41237.076489579886,
            40978.07138919158, 42907.85004137818, 45797.31497619826, 47298.08927667742, 46334.346426348624, 48381.8912958277, 47335.68457116948, 49922.31551687075, 47558.040732892434, 46216.703726404754, 48660.15998817887, 48918.98842075373,
            51380.59265631077, 52132.908088075965, 55265.51344098956, 57738.690406181646, 57113.993754648596, 58098.78560738437, 60110.697558145344, 64152.31021935193, 61386.36991470059, 50587.01719849433, 46366.267919942205, 46897.08825092531,
            48537.91486111503, 52830.337489364014, 53678.8922827356, 54021.874909011836, 53453.569837154544, 55352.12630107665, 59223.211243419464, 57212.20877076618, 59193.67146169965, 61559.61652450748, 61167.29304238174, 61772.09104022392,
            66530.23651002873, 66917.44002020075, 66917.03851528569, 68825.34672955025, 70004.83492356459, 70445.63352546077, 74970.4207865175, 74270.95275118499, 77521.37812350164, 72097.89512547171, 73885.3454107418, 73105.46300158801,
            67633.18425111714, 63859.5785151099, 61036.85056307657, 59369.44607056526, 64532.839630378774, 64488.22911444809, 63093.46313607065, 54653.87627339092, 48953.84082920841, 51937.2877574192, 50056.308445569186, 51690.661555202656,
            53696.03839975514, 57673.206652070745, 60905.15711383389, 64633.60909897523, 66962.4109913219, 65151.126504692795, 68295.93781870553, 66560.46510562068, 66401.3431823617, 67368.85198393356, 62003.58083032291, 64385.65318801702,
            63619.82764051358, 63883.08438209057, 62480.97344079284, 62760.410692048805, 63989.90289721302, 60057.13906322283, 57327.541184017624, 57222.521052475684, 57988.96907079799, 58745.71348590757, 63694.45082345413, 64147.674907806024,
            65599.61932989054, 68806.64596649997, 73133.88249791604, 73900.18254079277, 75770.08643780077, 77307.02050765016, 82225.0945110299, 86630.80170810358, 81629.71661846779, 84843.95986388587, 82173.80111756884, 86136.48090141875,
            93042.30076492437, 91464.5108432438, 85691.7686082059, 88576.7385285946, 86876.3617709675, 85208.77017769284, 84133.74721971164, 86747.8287619667, 83544.41871571058, 84259.97079491657, 81785.1990511987, 84246.46810984582,
            81266.12337183832, 81528.84341969769, 82118.7708814733, 83336.13589165211, 85328.47281298498, 84571.50239243411, 87752.24032544371, 88375.50408205789, 92097.03443530513, 89217.37093241034, 92495.14614665232, 96687.24930833215,
            99611.20517696098, 100773.132381904, 102363.81708397645, 105642.96432969705, 106995.48450504799, 106681.28624976898, 101326.26425399986, 101540.89491783835, 106409.88365052523, 107464.91084963172, 112009.60295487124, 112633.65152876382,
            117069.82555107115, 123552.63828839757, 122491.17455064926, 127159.80947713036, 134572.05451778104, 142847.83689100642, 153560.5123052454, 147350.23775778493, 151256.6138390343, 140670.86794401563, 140190.5015893399, 145703.51622969736,
            153183.99090702526, 163160.93670644032, 170652.24659611567, 171127.45656904115, 166383.9192603877, 171544.17313623577, 171648.62106685134, 148126.53873703408, 143689.37233193914, 150867.18500687953, 164439.9040039111, 171348.44221891378,
            180796.55679470647, 181806.6064864919, 194214.83370828498, 204605.64254084107, 199759.49364811045, 211639.39614297912, 203755.3449302743, 205692.81389361137, 201913.42143311736, 216688.52871432208, 230610.35476050669, 250512.99418231126,
            242288.2800773727, 244838.15944074243, 266141.69568614085, 267986.7222498553, 255050.10827660756, 256627.43990774656, 257817.0081875022, 276243.3113592198, 265729.3168800189, 272045.5854659542, 247639.25543011984, 234819.99849870172,
            239650.89705787727, 220438.45204394546, 215621.61521839644, 230368.32081145386, 237984.00999649244, 230494.19397394796, 220270.13823347213, 200438.54740649572, 183290.37078367945, 188628.8805784944, 202992.3216175121, 206217.79621333536,
            204023.7910288262, 201902.08766946686, 209031.99110487197, 195560.78373383282, 187977.92151641383, 166133.49618426026, 155100.92639628492, 154575.76544394187, 137180.24601685806, 147228.5159221501, 154159.50777591695, 138837.42258378377,
            130512.02798075438, 128632.22827951952, 126877.89942167643, 135193.15131186057, 134538.24963147243, 141580.25720835966, 145829.8071008977, 154292.8704787041, 145563.41564566983, 154584.9047950395, 152054.36205555347, 153445.46800453623,
            159004.63811456438, 161224.57529357894, 162696.47419695088, 163059.18826933578, 161158.95909201252, 165049.18716034506, 161198.73073141734, 160944.69461268224, 160051.19636439072, 159745.26147159206, 161080.06216990584, 163226.59221661455,
            166724.43460941807, 169125.54604054993, 169590.7912398462, 165985.15817405828, 177510.46337936883, 182585.29855443374, 188947.67694748845, 188732.71971307648, 196143.27275536233, 191687.066451716, 202348.84286781892, 206340.89233732974,
            209844.7516178599, 213820.04232276426, 214387.43005597586, 213267.13908941075, 200683.72658873344, 203070.95526149153, 203474.00851319218, 207391.08851789075, 213030.14670468692, 220222.71159759248, 217001.14334248385, 221917.35707023778,
            228281.1595796261, 222675.51970863878, 224929.89195155498, 229895.50613904087, 239007.35457794403, 236250.6324641869, 227613.98401736736, 227474.54202017738, 230326.10843651288, 232986.8598496981, 218709.7902575639, 216474.7392212931,
            197928.522288562, 192929.54215943883, 183285.78465006943, 196295.5840930236, 199699.986475483, 180788.14015367982, 178099.26392086272, 186036.88089184446, 168860.6874779441, 153428.49461673643, 143835.52119359814, 135756.74134553608,
            134504.58639078785, 122379.23275141061, 125041.15590260185, 139413.89690350948, 143169.6467256547, 142160.73322388367, 154157.68848690137, 159010.34673271034, 161158.92398061132, 156612.55217144376, 160592.44059568894, 170477.80059489416,
            168580.70975258332, 175946.02834225824, 188103.8675760578, 190447.44751449462, 186309.2059319428, 180449.209517727, 183743.59898204062, 181738.04445474027, 184592.4370936894, 188585.3067414826, 196707.82303860164, 205418.23596693212,
            204996.22919058462, 209995.8648289401, 202465.93818640747, 201792.1725267382, 204130.98042676295, 199956.46206858254, 198988.01814440382, 182535.78883432344, 178466.08010134273, 189921.604537392, 193334.99702988504, 200380.83425008014,
            206651.39559076686, 212441.11352361256, 216573.9656298778, 216415.4799241033, 210662.9377993188, 218108.91748474474, 226415.8451453313, 226136.1378488754, 226616.5383712506, 223993.7774108795, 226984.28095770988, 227607.36330765035,
            232917.00015213856, 240782.74164303517, 252657.82531872016, 255291.1007665033, 256683.50795584416, 248942.30855304707, 258198.79338420441, 253466.796924856, 260822.4428473896, 268329.77131514327, 273700.34603190416, 275843.8285916278,
            271031.5379847727, 278480.3452700548, 279389.03428945533, 280988.38612698956, 291633.55147304013, 295742.1402166764, 297091.1886236088, 308035.1752794275, 314083.3655218422, 317604.3742209276, 325033.47795628244, 328800.51832220104,
            346716.8438486681, 369153.0207180961, 379619.79077753314, 372725.55846324, 382362.51981621265, 366161.8219623446, 380279.52341622126, 347261.9628898927, 334811.61987012916, 367444.0919357211, 380753.3028311568, 363478.2643024697,
            340700.71174003126, 339158.94570260134, 346363.5859666254, 351288.92036680126, 361148.07866792823, 358773.9176487272, 373561.4143701499, 373233.7553825198, 374241.42262952926, 374207.28087554907, 390688.36822607514, 403604.24512705766,
            405120.6495537613, 422568.0058265258, 423314.19588194246, 420188.69421122666, 417950.07852489385, 412536.0864162126, 411062.7127959523, 408230.04971971683, 418064.20015282405, 432113.9841518363, 433615.27511633723, 434202.4777412793,
            440101.2178965249, 430262.1464833315, 417228.8644593668, 430478.4048628936, 447246.1646248766, 448604.95825159445, 459541.8254727306, 468621.7621348341, 474284.180484492, 449476.23442627396, 452941.4068593441, 415174.55792518426,
            445997.4201774572, 462305.9594939658, 475923.8434171276, 493546.57369094866, 467862.8165261699, 488657.37123599893, 501162.7662374294, 496027.2187867925, 513422.0061230561, 513978.8229862183, 536567.3940731816, 540245.1776247153,
            545799.2645173206, 503079.3821788027, 437337.16734981013, 488682.04136553156, 500328.6294323941, 510719.3856089005, 505793.5817970517, 535430.1946260751, 527202.1107953145, 511467.02193003474, 563285.0712466314, 573242.1670965339,
            573858.2691392895, 589291.3543261647, 629463.2180545023, 639293.4715252456, 642177.7502744969, 669134.3749599874, 680719.548343914, 701021.9054239772, 686712.4158920497, 721495.6823644936, 723198.844838573, 756571.9801449956,
            727460.0848749744, 706339.1613572572, 732130.2464883362, 707040.6844588212, 696149.8277558046, 655804.2932234461, 720991.7586758115, 704527.4437804917, 655554.6788803298, 690867.0682405854, 706003.0916860258, 657640.5600279866,
            693317.2073211351, 690287.1415167826, 694865.1891246431, 700220.6730653651, 712567.5961556862, 742935.598895187, 756955.8338300635, 749413.2711877194, 735631.2369086111, 712604.6794219364, 757166.3427930666, 785784.4342333137,
            810844.0442109375, 846080.7267240374, 874481.0394525726, 849304.6831396248, 876272.4418082598, 906380.4276370538, 911875.6486115364, 914111.8851203562, 921790.4328540992, 929575.6308922447, 1001686.631880757, 991827.676110626,
            1026432.7231471179, 1017283.4172351286, 935684.0796237949, 897683.5625529448, 953670.1463012428, 962483.609688693, 998210.3194934728, 1005623.187012044, 1030612.307866548, 1068264.982868785, 1070171.09805118, 1061927.8303842624,
            1070298.6659424987
        ];

        console.log('MSCI_INDEX length:', MSCI_INDEX.length); // Dovrebbe essere 566

        // Cache
        let cache = new Map();

        // Sincronizza slider allocazione
        function updateAllocation() {
            const guaranteed = parseInt(document.getElementById('guaranteedPct').value);
            const msci = 100 - guaranteed;
            
            document.getElementById('msciPct').value = msci;
            document.getElementById('guaranteedPctValue').innerText = guaranteed + '%';
            document.getElementById('msciPctValue').innerText = msci + '%';
            document.getElementById('allocationDescription').innerHTML = 
                `${msci}% MSCI World | ${guaranteed}% Garantito 2% (composto annuo)`;
            
            // Non avviamo la simulazione automaticamente
        }

        document.getElementById('guaranteedPct').addEventListener('input', updateAllocation);
        document.getElementById('msciPct').addEventListener('input', function() {
            const msci = parseInt(this.value);
            const guaranteed = 100 - msci;
            document.getElementById('guaranteedPct').value = guaranteed;
            updateAllocation();
        });

        // FUNZIONE CORRETTA PER CALCOLARE IL RENDIMENTO
        function calculateReturn(startIdx, months, holdingMonths, type) {
            const guaranteedPct = parseInt(document.getElementById('guaranteedPct').value) / 100;
            const msciPct = 1 - guaranteedPct;
            
            const lumpAmount = parseFloat(document.getElementById('lumpAmount').value);
            const pacAmount = parseFloat(document.getElementById('pacAmount').value);
            
            let value;
            let totalInvested;
            const totalMonths = months + holdingMonths;
            
            if (type === 'lump') {
                // PIC - Investimento unico
                const guaranteedPart = lumpAmount * guaranteedPct;
                const msciPart = lumpAmount * msciPct;
                
                let guaranteedValue = guaranteedPart;
                let msciValue = msciPart;
                
                for (let i = 0; i < totalMonths; i++) {
                    // La parte garantita cresce al 2% annuo (capitalizzazione mensile)
                    guaranteedValue *= (1 + 0.02/12);
                    
                    // La parte MSCI World segue l'andamento storico
                    msciValue *= (1 + RETURNS[startIdx + i] / 100);
                }
                
                value = guaranteedValue + msciValue;
                totalInvested = lumpAmount;
                
            } else {
                // PAC - Piano di Accumulo
                const guaranteedMonthly = pacAmount * guaranteedPct;
                const msciMonthly = pacAmount * msciPct;
                
                // FASE 1: Accumulo (con versamenti mensili)
                let guaranteedValue = 0;
                let msciValue = 0;
                
                for (let i = 0; i < months; i++) {
                    // Ogni mese aggiungiamo il versamento e poi applichiamo il rendimento del mese
                    guaranteedValue = (guaranteedValue + guaranteedMonthly) * (1 + 0.02/12);
                    msciValue = (msciValue + msciMonthly) * (1 + RETURNS[startIdx + i] / 100);
                }
                
                // FASE 2: Detenzione (senza versamenti)
                for (let i = 0; i < holdingMonths; i++) {
                    guaranteedValue *= (1 + 0.02/12);
                    msciValue *= (1 + RETURNS[startIdx + months + i] / 100);
                }
                
                value = guaranteedValue + msciValue;
                totalInvested = pacAmount * months;
            }
            
            return { value, totalInvested };
        }

        // Calcola volatilit√† annualizzata dai rendimenti mensili
        function calculateVolatility(returns) {
            if (returns.length === 0) return 0;
            
            // Calcola media dei rendimenti
            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            
            // Calcola deviazione standard
            const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
            const monthlyStd = Math.sqrt(variance);
            
            // Annualizza (radice di 12)
            const annualizedStd = monthlyStd * Math.sqrt(12);
            
            return annualizedStd;
        }

        // Calcola tutti i periodi rolling
        function calculateAllPeriods(type) {
            const duration = parseFloat(document.getElementById('duration').value);
            const holding = parseFloat(document.getElementById('holdingPeriod').value);
            const months = duration * 12;
            const holdingMonths = holding * 12;
            const totalMonths = months + holdingMonths;
            
            const periods = [];
            const maxStart = RETURNS.length - totalMonths;
            
            for (let start = 0; start < maxStart; start++) {
                const result = calculateReturn(start, months, holdingMonths, type);
                const finalValue = result.value;
                const invested = result.totalInvested;
                const gain = finalValue - invested;
                const gainPct = (gain/invested)*100;
                const totalYears = totalMonths / 12;
                const annualReturn = (Math.pow(finalValue/invested, 1/totalYears) - 1) * 100;
                
                // Calcola volatilit√† per questo periodo
                const periodReturns = [];
                for (let i = 0; i < totalMonths; i++) {
                    periodReturns.push(RETURNS[start + i]);
                }
                const volatility = calculateVolatility(periodReturns);
                
                periods.push({
                    startIdx: start,
                    startDate: new Date(1979, start, 1),
                    endAccumuloDate: new Date(1979, start + months, 1),
                    endDate: new Date(1979, start + totalMonths, 1),
                    invested,
                    finalValue,
                    gain,
                    gainPct,
                    annualReturn,
                    periodReturn: gainPct,
                    volatility: volatility,
                    monthlyReturns: periodReturns
                });
            }
            
            return periods;
        }

        // Calcola un percorso per il grafico
        function calculatePath(startIdx, months, holdingMonths, type) {
            const guaranteedPct = parseInt(document.getElementById('guaranteedPct').value) / 100;
            const msciPct = 1 - guaranteedPct;
            
            const lumpAmount = parseFloat(document.getElementById('lumpAmount').value);
            const pacAmount = parseFloat(document.getElementById('pacAmount').value);
            
            const path = [];
            const totalMonths = months + holdingMonths;
            
            if (type === 'lump') {
                const guaranteedPart = lumpAmount * guaranteedPct;
                const msciPart = lumpAmount * msciPct;
                
                let guaranteedValue = guaranteedPart;
                let msciValue = msciPart;
                
                // Valore iniziale
                path.push(guaranteedValue + msciValue);
                
                for (let i = 0; i < totalMonths; i++) {
                    guaranteedValue *= (1 + 0.02/12);
                    msciValue *= (1 + RETURNS[startIdx + i] / 100);
                    
                    // Salviamo ogni 3 mesi
                    if (i % 3 === 2) {
                        path.push(guaranteedValue + msciValue);
                    }
                }
            } else {
                let guaranteedValue = 0;
                let msciValue = 0;
                
                path.push(0); // Punto iniziale
                
                // Fase accumulo
                for (let i = 0; i < months; i++) {
                    guaranteedValue = (guaranteedValue + pacAmount * guaranteedPct) * (1 + 0.02/12);
                    msciValue = (msciValue + pacAmount * msciPct) * (1 + RETURNS[startIdx + i] / 100);
                    
                    if (i % 3 === 2) {
                        path.push(guaranteedValue + msciValue);
                    }
                }
                
                // Fase detenzione
                for (let i = 0; i < holdingMonths; i++) {
                    guaranteedValue *= (1 + 0.02/12);
                    msciValue *= (1 + RETURNS[startIdx + months + i] / 100);
                    
                    if (i % 3 === 2) {
                        path.push(guaranteedValue + msciValue);
                    }
                }
            }
            
            return path;
        }

        // FUNZIONE CORRETTA PER IL PERCORSO MSCI WORLD
        function calculateMsciPath(startIdx, months, holdingMonths) {
            const totalMonths = months + holdingMonths;
            const path = [];
            
            // MSCI_INDEX[0] = Dic 1978
            // startIdx = 0 corrisponde a Gen 1979 (RETURNS[0])
            // Quindi per Gen 1979 usiamo MSCI_INDEX[1]
            const msciStartIdx = startIdx + 1;
            
            // Aggiungiamo il valore all'inizio del periodo
            if (msciStartIdx < MSCI_INDEX.length) {
                path.push(MSCI_INDEX[msciStartIdx]);
            } else {
                path.push(MSCI_INDEX[MSCI_INDEX.length - 1]);
            }
            
            // Aggiungiamo i valori ogni 3 mesi durante il periodo
            for (let i = 3; i <= totalMonths; i += 3) {
                const idx = msciStartIdx + i;
                if (idx < MSCI_INDEX.length) {
                    path.push(MSCI_INDEX[idx]);
                } else {
                    path.push(MSCI_INDEX[MSCI_INDEX.length - 1]);
                }
            }
            
            return path;
        }

        // Calcola linea versamenti per un singolo viaggio
        function calculateContributionLine(months, holdingMonths, type) {
            const lumpAmount = parseFloat(document.getElementById('lumpAmount').value);
            const pacAmount = parseFloat(document.getElementById('pacAmount').value);
            const totalMonths = months + holdingMonths;
            
            const line = [];
            
            if (type === 'lump') {
                // PIC: versamento unico all'inizio
                line.push(lumpAmount);
                for (let i = 1; i <= Math.floor(totalMonths/3); i++) {
                    line.push(lumpAmount);
                }
            } else {
                // PAC: versamenti mensili cumulati
                let total = 0;
                line.push(0); // Inizio
                
                // Durante l'accumulo, il capitale versato cresce
                for (let i = 0; i < months; i++) {
                    total += pacAmount;
                    if (i % 3 === 2) {
                        line.push(total);
                    }
                }
                
                // Durante la detenzione, il capitale versato rimane costante
                const remainingPoints = Math.floor(holdingMonths / 3);
                for (let i = 0; i < remainingPoints; i++) {
                    line.push(total);
                }
            }
            
            return line;
        }

        // Calcola linea garantita di riferimento
        function calculateReferenceGuaranteedLine(months, holdingMonths, type) {
            const lumpAmount = parseFloat(document.getElementById('lumpAmount').value);
            const pacAmount = parseFloat(document.getElementById('pacAmount').value);
            const totalMonths = months + holdingMonths;
            
            const line = [];
            
            if (type === 'lump') {
                let value = lumpAmount;
                line.push(value);
                for (let i = 0; i < totalMonths; i++) {
                    value *= (1 + 0.02/12);
                    if (i % 3 === 2) {
                        line.push(value);
                    }
                }
            } else {
                let value = 0;
                line.push(0);
                
                // Fase accumulo
                for (let i = 0; i < months; i++) {
                    value = (value + pacAmount) * (1 + 0.02/12);
                    if (i % 3 === 2) {
                        line.push(value);
                    }
                }
                
                // Fase detenzione
                for (let i = 0; i < holdingMonths; i++) {
                    value *= (1 + 0.02/12);
                    if (i % 3 === 2) {
                        line.push(value);
                    }
                }
            }
            
            return line;
        }

        // Genera etichette per l'asse X con anni
        function generateYearLabels(startIdx, months, holdingMonths) {
            const totalMonths = months + holdingMonths;
            const labels = [];
            const startDate = new Date(1979, startIdx, 1);
            
            // Genera etichette ogni 12 mesi (ogni anno)
            for (let i = 0; i <= totalMonths; i += 12) {
                const currentDate = new Date(1979, startIdx + i, 1);
                const year = currentDate.getFullYear();
                const month = currentDate.toLocaleDateString('it-IT', { month: 'short' });
                labels.push({
                    index: Math.floor(i / 3), // Conversione per punti ogni 3 mesi
                    label: `${month} ${year}`
                });
            }
            
            return labels;
        }

        // Aggiorna tutte le visualizzazioni
        function updateSimulation() {
            const duration = parseFloat(document.getElementById('duration').value);
            document.getElementById('durationValue').innerText = duration + ' anni';
            
            updateTotalPac();
            updateTotalPeriod();
            
            // Usa il tipo di investimento corrente
            const type = currentInvestmentType;
            
            console.log('Calcolo simulazioni con tipo:', type);
            const periods = calculateAllPeriods(type);
            console.log(`Trovati ${periods.length} periodi`);
            updateStats(periods);
            updateTable(periods);
            updateBundleChart(type);
            updateComparison();
        }

        function updateStats(periods) {
            if (periods.length === 0) return;
            
            const returns = periods.map(p => p.annualReturn);
            const periodReturns = periods.map(p => p.periodReturn);
            const volatilities = periods.map(p => p.volatility);
            
            const avg = (returns.reduce((a,b) => a + b, 0) / returns.length).toFixed(2);
            const avgPeriod = (periodReturns.reduce((a,b) => a + b, 0) / periodReturns.length).toFixed(2);
            const max = Math.max(...returns).toFixed(2);
            const min = Math.min(...returns).toFixed(2);
            const positive = (returns.filter(r => r > 0).length / returns.length * 100).toFixed(1);
            const avgVol = (volatilities.reduce((a,b) => a + b, 0) / volatilities.length).toFixed(2);
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card"><div class="stat-label">Media Annua</div><div class="stat-value">${avg}%</div></div>
                <div class="stat-card"><div class="stat-label">Media Periodo</div><div class="stat-value">${avgPeriod}%</div></div>
                <div class="stat-card"><div class="stat-label">Miglior Annuo</div><div class="stat-value">${max}%</div></div>
                <div class="stat-card"><div class="stat-label">Peggior Annuo</div><div class="stat-value">${min}%</div></div>
                <div class="stat-card highlight"><div class="stat-label">Viaggi</div><div class="stat-value">${periods.length}</div></div>
                <div class="stat-card"><div class="stat-label">Positivi</div><div class="stat-value">${positive}%</div></div>
                <div class="stat-card volatility"><div class="stat-label">Volatilit√† Media</div><div class="stat-value">${avgVol}%</div></div>
            `;
            
            document.getElementById('simCount').innerText = periods.length;
        }

        function updateTable(periods) {
            const displayType = document.getElementById('displayType').value;
            let filtered = [...periods];
            
            if (displayType === 'best') {
                filtered = periods.sort((a,b) => b.annualReturn - a.annualReturn).slice(0, 10);
            } else if (displayType === 'worst') {
                filtered = periods.sort((a,b) => a.annualReturn - b.annualReturn).slice(0, 10);
            }
            
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = filtered.map((p) => {
                const startDate = p.startDate.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' });
                const endAccumuloDate = p.endAccumuloDate.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' });
                const endDate = p.endDate.toLocaleDateString('it-IT', { month: 'short', year: 'numeric' });
                
                return `<tr>
                    <td>${startDate} - ${endAccumuloDate}</td>
                    <td>${endAccumuloDate} - ${endDate}</td>
                    <td>‚Ç¨${Math.round(p.invested).toLocaleString()}</td>
                    <td>‚Ç¨${Math.round(p.finalValue).toLocaleString()}</td>
                    <td class="${p.gain >= 0 ? 'positive' : 'negative'}">
                        ‚Ç¨${Math.round(p.gain).toLocaleString()} (${p.gainPct.toFixed(1)}%)
                    </td>
                    <td class="${p.periodReturn >= 0 ? 'positive' : 'negative'}">${p.periodReturn.toFixed(2)}%</td>
                    <td class="${p.annualReturn >= 0 ? 'positive' : 'negative'}">${p.annualReturn.toFixed(2)}%</td>
                    <td>${p.volatility.toFixed(2)}%</td>
                    <td><button class="view-trip-btn" onclick="showTrip(${p.startIdx})">üîç Visualizza</button></td>
                </tr>`;
            }).join('');
        }

        function updateBundleChart(type) {
            const duration = parseFloat(document.getElementById('duration').value);
            const holding = parseFloat(document.getElementById('holdingPeriod').value);
            const months = duration * 12;
            const holdingMonths = holding * 12;
            const totalMonths = months + holdingMonths;
            
            const paths = [];
            const maxStart = RETURNS.length - totalMonths;
            const step = Math.max(1, Math.floor(maxStart / 50));
            
            const allValues = [];
            
            for (let start = 0; start < maxStart; start += step) {
                const path = calculatePath(start, months, holdingMonths, type);
                paths.push(path);
                
                path.forEach((val, idx) => {
                    if (!allValues[idx]) allValues[idx] = [];
                    if (val > 0) allValues[idx].push(val);
                });
            }
            
            const averagePath = allValues.map(arr => 
                arr.length ? arr.reduce((a,b) => a + b, 0) / arr.length : 0
            );
            
            const contributionLine = calculateContributionLine(months, holdingMonths, type);
            const guaranteedLine = calculateReferenceGuaranteedLine(months, holdingMonths, type);
            
            const labels = Array.from({length: paths[0]?.length || 0}, (_, i) => {
                const year = (i * 3 / 12).toFixed(1);
                return `${year} anni`;
            });
            
            if (bundleChart) bundleChart.destroy();
            
            const datasets = paths.map(path => ({
                data: path,
                borderColor: `rgba(52, 152, 219, 0.5)`,
                borderWidth: 1.0,
                pointRadius: 0,
                tension: 0.1
            }));
            
            datasets.push({
                label: 'Media percorsi',
                data: averagePath,
                borderColor: '#f39c12',
                borderWidth: 3,
                pointRadius: 0,
                tension: 0.1
            });
            
            datasets.push({
                label: 'Capitale Versato',
                data: contributionLine,
                borderColor: '#e74c3c',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                tension: 0
            });
            
            datasets.push({
                label: 'Garantito 2% (riferimento)',
                data: guaranteedLine,
                borderColor: '#27ae60',
                borderWidth: 2,
                borderDash: [2, 2],
                pointRadius: 0,
                tension: 0
            });
            
            bundleChart = new Chart(document.getElementById('bundleChart'), {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 0 },
                    plugins: { 
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    elements: { line: { borderWidth: 1.0 } }
                }
            });
        }

        function updateComparison() {
            setTimeout(() => {
                const lumpResults = [];
                const pacResults = [];
                const detResults = [];
                
                const maxStart = RETURNS.length - 120; // 10 anni di dati
                
                for (let start = 0; start < maxStart; start += 12) { // Campionamento annuale
                    // PIC 5 anni (60 mesi)
                    const resultLump = calculateReturn(start, 60, 0, 'lump');
                    const lumpAnnualReturn = (Math.pow(resultLump.value / resultLump.totalInvested, 1/5) - 1) * 100;
                    lumpResults.push(lumpAnnualReturn);
                    
                    // PAC 5 anni
                    const resultPac = calculateReturn(start, 60, 0, 'pac');
                    const pacAnnualReturn = (Math.pow(resultPac.value / resultPac.totalInvested, 1/5) - 1) * 100;
                    pacResults.push(pacAnnualReturn);
                    
                    // PAC 5 anni + 5 anni detenzione
                    const resultDet = calculateReturn(start, 60, 60, 'pac');
                    const detAnnualReturn = (Math.pow(resultDet.value / resultDet.totalInvested, 1/10) - 1) * 100;
                    detResults.push(detAnnualReturn);
                }
                
                // Calcolo medie
                const lumpAvg = lumpResults.reduce((a,b) => a + b, 0) / lumpResults.length;
                const pacAvg = pacResults.reduce((a,b) => a + b, 0) / pacResults.length;
                const detAvg = detResults.reduce((a,b) => a + b, 0) / detResults.length;
                
                // Aggiornamento DOM
                document.getElementById('lumpAvg').innerText = lumpAvg.toFixed(2) + '%';
                document.getElementById('lumpBest').innerHTML = `üìà Migliore: ${Math.max(...lumpResults).toFixed(2)}%`;
                document.getElementById('lumpWorst').innerHTML = `üìâ Peggiore: ${Math.min(...lumpResults).toFixed(2)}%`;
                
                document.getElementById('pacAvg').innerText = pacAvg.toFixed(2) + '%';
                document.getElementById('pacBest').innerHTML = `üìà Migliore: ${Math.max(...pacResults).toFixed(2)}%`;
                document.getElementById('pacWorst').innerHTML = `üìâ Peggiore: ${Math.min(...pacResults).toFixed(2)}%`;
                
                document.getElementById('detAvg').innerText = detAvg.toFixed(2) + '%';
                document.getElementById('detBest').innerHTML = `üìà Migliore: ${Math.max(...detResults).toFixed(2)}%`;
                document.getElementById('detWorst').innerHTML = `üìâ Peggiore: ${Math.min(...detResults).toFixed(2)}%`;
                
            }, 100);
        }

        // Funzione per mostrare il dettaglio di un viaggio specifico
        window.showTrip = function(startIdx) {
            console.log('showTrip called with startIdx:', startIdx);
            
            const duration = parseFloat(document.getElementById('duration').value);
            const holding = parseFloat(document.getElementById('holdingPeriod').value);
            const months = duration * 12;
            const holdingMonths = holding * 12;
            const totalMonths = months + holdingMonths;
            
            console.log('Params:', { duration, holding, months, holdingMonths, totalMonths });
            
            const result = calculateReturn(startIdx, months, holdingMonths, currentInvestmentType);
            const path = calculatePath(startIdx, months, holdingMonths, currentInvestmentType);
            
            // Usa i valori REALI dell'indice con la funzione corretta
            const msciPath = calculateMsciPath(startIdx, months, holdingMonths);
            
            const contributionLine = calculateContributionLine(months, holdingMonths, currentInvestmentType);
            
            const startDate = new Date(1979, startIdx, 1);
            const endAccumuloDate = new Date(1979, startIdx + months, 1);
            const endDate = new Date(1979, startIdx + totalMonths, 1);
            
            // Calcola il rendimento reale dell'indice nel periodo
            const msciStartIdx = startIdx + 1;
            const startValue = msciStartIdx < MSCI_INDEX.length ? MSCI_INDEX[msciStartIdx] : 0;
            const endValue = msciPath.length > 0 ? msciPath[msciPath.length - 1] : 0;
            const msciReturn = startValue > 0 ? ((endValue / startValue) - 1) * 100 : 0;
            
            console.log('MSCI values:', { startValue, endValue, msciReturn });
            
            // Genera etichette per l'asse X con anni
            const yearLabels = generateYearLabels(startIdx, months, holdingMonths);
            const labels = Array.from({length: path.length}, (_, i) => {
                const yearLabel = yearLabels.find(yl => yl.index === i);
                if (yearLabel) {
                    return yearLabel.label;
                } else {
                    const years = (i * 3 / 12).toFixed(1);
                    return `${years} a`;
                }
            });
            
            // Popola dettagli con il rendimento reale dell'indice
            document.getElementById('tripDetails').innerHTML = `
                <div>
                    <div class="detail-item"><span class="detail-label">Periodo accumulo:</span> <span class="detail-value">${startDate.toLocaleDateString('it-IT')} - ${endAccumuloDate.toLocaleDateString('it-IT')}</span></div>
                    <div class="detail-item"><span class="detail-label">Periodo detenzione:</span> <span class="detail-value">${endAccumuloDate.toLocaleDateString('it-IT')} - ${endDate.toLocaleDateString('it-IT')}</span></div>
                    <div class="detail-item"><span class="detail-label">Capitale investito:</span> <span class="detail-value">‚Ç¨${Math.round(result.totalInvested).toLocaleString()}</span></div>
                    <div class="detail-item"><span class="detail-label">Valore finale:</span> <span class="detail-value">‚Ç¨${Math.round(result.value).toLocaleString()}</span></div>
                </div>
                <div>
                    <div class="detail-item"><span class="detail-label">Plusvalenza:</span> <span class="detail-value ${result.value - result.totalInvested >= 0 ? 'positive' : 'negative'}">‚Ç¨${Math.round(result.value - result.totalInvested).toLocaleString()}</span></div>
                    <div class="detail-item"><span class="detail-label">Rendimento totale:</span> <span class="detail-value ${result.value - result.totalInvested >= 0 ? 'positive' : 'negative'}">${(((result.value/result.totalInvested)-1)*100).toFixed(2)}%</span></div>
                    <div class="detail-item"><span class="detail-label">Rendimento annuo:</span> <span class="detail-value ${result.value - result.totalInvested >= 0 ? 'positive' : 'negative'}">${((Math.pow(result.value/result.totalInvested, 1/(totalMonths/12)) - 1) * 100).toFixed(2)}%</span></div>
                    <div class="detail-item"><span class="detail-label">Rendimento MSCI World nel periodo:</span> <span class="detail-value">${msciReturn.toFixed(2)}%</span></div>
                    ${startValue > 0 ? `
                    <div class="detail-item"><span class="detail-label">Valore MSCI World inizio:</span> <span class="detail-value">${Math.round(startValue).toLocaleString()}</span></div>
                    <div class="detail-item"><span class="detail-label">Valore MSCI World fine:</span> <span class="detail-value">${Math.round(endValue).toLocaleString()}</span></div>
                    ` : ''}
                </div>
            `;
            
            // Aggiorna etichetta del periodo MSCI
            document.getElementById('msciPeriodLabel').innerHTML = startValue > 0 ? 
                `Valori reali (da ${Math.round(startValue).toLocaleString()} a ${Math.round(endValue).toLocaleString()})` :
                `Valori reali dell'indice`;
            
            // Crea grafico dell'investimento con linea versamenti
            if (tripInvestmentChart) tripInvestmentChart.destroy();
            
            tripInvestmentChart = new Chart(document.getElementById('tripInvestmentChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Andamento investimento',
                            data: path,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Capitale Versato',
                            data: contributionLine,
                            borderColor: '#e74c3c',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            tension: 0,
                            fill: false,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '‚Ç¨' + Math.round(context.parsed.y).toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 9
                                }
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç¨' + Math.round(value).toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Euro (‚Ç¨)'
                            }
                        }
                    }
                }
            });
            
            // Crea grafico dell'MSCI World (valori reali) con la funzione corretta
            if (tripMsciChart) tripMsciChart.destroy();
            
            tripMsciChart = new Chart(document.getElementById('tripMsciChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'MSCI World',
                            data: msciPath,
                            borderColor: '#2c3e50',
                            backgroundColor: 'rgba(44, 62, 80, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.1,
                            pointRadius: 1,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Valore: ' + Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 9
                                }
                            }
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return Math.round(value).toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Valore indice'
                            }
                        }
                    }
                }
            });
            
            // Mostra modal
            document.getElementById('tripModal').style.display = 'block';
        };

        // Chiudi modal
        document.getElementById('closeModal').addEventListener('click', function() {
            document.getElementById('tripModal').style.display = 'none';
        });

        window.onclick = function(event) {
            const modal = document.getElementById('tripModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
            });
        });

        // Selezione strategia
        document.getElementById('pacSection').addEventListener('click', function() {
            currentInvestmentType = 'pac';
            this.classList.add('selected');
            document.getElementById('picSection').classList.remove('selected');
        });

        document.getElementById('picSection').addEventListener('click', function() {
            currentInvestmentType = 'lump';
            this.classList.add('selected');
            document.getElementById('pacSection').classList.remove('selected');
        });

        // Event listeners per aggiornamenti in tempo reale (solo UI, non simulazione)
        document.getElementById('duration').addEventListener('input', function() {
            document.getElementById('durationValue').innerText = this.value + ' anni';
            updateTotalPac();
            updateTotalPeriod();
        });
        
        document.getElementById('holdingPeriod').addEventListener('input', function() {
            document.getElementById('holdingValue').innerText = this.value + ' anni';
            updateTotalPeriod();
        });
        
        document.getElementById('pacAmount').addEventListener('input', updateTotalPac);
        
        // Pulsante Avvia Macchina del Tempo
        document.getElementById('startSimulation').addEventListener('click', function() {
            // Effetto visivo di feedback
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 200);
            
            // Avvia la simulazione
            updateSimulation();
        });

        // Inizializza valori (senza avviare la simulazione)
        updateTotalPac();
        updateTotalPeriod();
        updateAllocation();
        
        // Imposta selezione iniziale per PAC
        document.getElementById('pacSection').classList.add('selected');
        
        // Cleanup cache ogni 5 minuti
        setInterval(() => {
            cache.clear();
            console.log('Cache pulita');
        }, 300000);
    </script>
</body>
</html>
